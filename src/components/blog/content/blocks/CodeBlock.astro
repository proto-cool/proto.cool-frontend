---
import generateCodeBlock from "@lib/codeHighlighting";

interface Props {
    code: string;
    title?: string;
    language: string;
    meta?: string;
}

const { code, title, language, meta } = Astro.props;

const highlightedCode = await generateCodeBlock(code, language, meta);
---

<div
    class="relative code-block group my-8 border border-theme-bg-tertiary rounded-2xl overflow-hidden shadow-sm"
    data-code={code}
>
    <!-- Header -->
    <div class="flex items-center justify-between px-6 py-3 bg-theme-bg-secondary border-b border-theme-bg-tertiary">
        <div class="flex items-center gap-2">
            <span class="text-sm font-medium text-theme-fg-tertiary lowercase">
                {language}
            </span>
            {
                title && (
                    <span class="text-sm font-medium text-theme-fg-secondary border-l border-theme-bg-tertiary pl-2">
                        {title}
                    </span>
                )
            }
        </div>
        <button
            class="copy-button p-1.5 rounded-full text-theme-fg-tertiary hover:text-theme-fg-primary hover:bg-theme-bg-tertiary transition-all duration-200 active:scale-95"
            aria-label="Copy code"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="copy-icon"
            >
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="check-icon hidden"
            >
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        </button>
    </div>

    <!-- Code block -->
    <Fragment set:html={highlightedCode} />
</div>

<script>
    function setupCopyButtons() {
        const codeBlocks = document.querySelectorAll(".code-block");

        codeBlocks.forEach((block) => {
            const button = block.querySelector(".copy-button");
            const code = block.getAttribute("data-code");
            const copyIcon = button?.querySelector(".copy-icon");
            const checkIcon = button?.querySelector(".check-icon");

            if (!button || !code || !copyIcon || !checkIcon) return;

            button.addEventListener("click", async () => {
                try {
                    await navigator.clipboard.writeText(code);

                    // Show check icon
                    copyIcon.classList.add("hidden");
                    checkIcon.classList.remove("hidden");
                    button.classList.add("text-theme-color-primary");

                    // Reset after 2 seconds
                    setTimeout(() => {
                        copyIcon.classList.remove("hidden");
                        checkIcon.classList.add("hidden");
                        button.classList.remove("text-theme-color-primary");
                    }, 2000);
                } catch (err) {
                    console.error("Failed to copy code: ", err);
                }
            });
        });
    }

    // Run on initial load
    setupCopyButtons();

    // Re-run on view transitions if you use them
    document.addEventListener("astro:page-load", setupCopyButtons);
</script>
