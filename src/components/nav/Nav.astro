---
import NavLink from "@components/nav/NavLink.astro";
import Logo from "@components/logo/Logo.astro";
import SiteConfig from "@/site.config";
import ThemePicker from "@components/nav/buttons/ThemePicker.astro";
import MobileNavButton from "./buttons/MobileNavButton.astro";
---

<style>
    @reference "@/styles/main.css";
    
    @property --nav-content-height {
        syntax: "<length>";
        inherits: true;
        initial-value: 0px;
    }

    @property --nav-mask-height {
        syntax: "<length>";
        inherits: true;
        initial-value: 0px;
    }

    @property --nav-fade-distance {
        syntax: "<length>";
        inherits: true;
        initial-value: 0px;
    }

    @property --nav-height {
        syntax: "<length>";
        inherits: true;
        initial-value: 0px;
    }

    #nav {
        @apply fixed top-0 left-0 z-40 flex w-full h-dvh flex-col pointer-events-none;
        transition:
            --nav-height 150ms ease-in-out,
            --nav-content-height 150ms ease-in-out,
            --nav-mask-height 150ms ease-in-out,
            --nav-fade-distance 150ms ease-in-out;

        /* Default configuration: "closed" state */
        --nav-content-height: theme(spacing.16);
        --nav-fade-distance: theme(spacing.6);
        --nav-mask-height: var(--nav-content-height);
        --nav-height: calc(var(--nav-mask-height) + var(--nav-fade-distance));

        @variant md {
            --nav-content-height: theme(spacing.20);
        }

        @variant lg {
            --nav-content-height: theme(spacing.24);
        }
    }

    /* Squished state */
    #nav[data-nav-squished="true"] {
        --nav-content-height: theme(spacing.12);

        @variant md {
            --nav-content-height: theme(spacing.14);
        }

        @variant lg {
            --nav-content-height: theme(spacing.16);
        }

        & :where(.font-cool) {
            @apply text-2xl;
        }
    }

    /* State: Search */
    #nav[data-nav-state="search"] {
        --nav-mask-height: 75vh;
    }

    /* State: Mobile Open */
    #nav[data-nav-state="mobile-open"] {
        @apply overflow-y-auto overflow-x-hidden pointer-events-auto;
        --nav-mask-height: 100dvh;
        --nav-height: 100dvh;
        --nav-fade-distance: 0px;
        --nav-content-height: theme(spacing.16);

        @variant md {
            --nav-content-height: theme(spacing.20);
        }

        @variant lg {
            --nav-content-height: theme(spacing.24);
        }

        & :where(.font-cool) {
            @apply text-3xl;
        }
    }

    /* Background & Effects */
    #nav-background-blur {
        @apply absolute inset-x-0 top-0 bottom-0 z-10 backdrop-blur-md;
        background-color: color-mix(in srgb, var(--color-bg-primary), transparent 10%);

        mask-image: linear-gradient(
            to bottom,
            black 0%,
            black var(--nav-mask-height),
            rgba(0, 0, 0, 0.7) calc(var(--nav-mask-height) + var(--nav-fade-distance) * 0.2),
            rgba(0, 0, 0, 0.4) calc(var(--nav-mask-height) + var(--nav-fade-distance) * 0.5),
            rgba(0, 0, 0, 0.1) calc(var(--nav-mask-height) + var(--nav-fade-distance) * 0.8),
            transparent var(--nav-height)
        );
    }

    #nav-dots {
        @apply absolute inset-x-0 top-0 bottom-0 z-[11];
        background-image: radial-gradient(var(--color-bg-primary) 1px, transparent 1px);
        background-size: 3px 3px;

        mask-image: linear-gradient(
            to bottom,
            black 0%,
            black var(--nav-mask-height),
            rgba(0, 0, 0, 0.7) calc(var(--nav-mask-height) + var(--nav-fade-distance) * 0.2),
            rgba(0, 0, 0, 0.4) calc(var(--nav-mask-height) + var(--nav-fade-distance) * 0.5),
            rgba(0, 0, 0, 0.1) calc(var(--nav-mask-height) + var(--nav-fade-distance) * 0.8),
            transparent var(--nav-height)
        );
    }

    #nav-content {
        @apply container mx-auto flex items-center justify-between z-20 pointer-events-auto;
        height: var(--nav-content-height);
        flex-shrink: 0;
    }

    /* Mobile Links Container */
    #nav-mobile-links {
        @apply container flex-col gap-4 items-start py-6 z-20 pointer-events-auto;
        @apply flex opacity-0 -translate-y-4 transition-all duration-150 ease-out;
        will-change: transform, opacity;
        @apply group-data-[nav-state="closed"]:hidden;
        @apply group-data-[nav-state="mobile-open"]:opacity-100 group-data-[nav-state="mobile-open"]:translate-y-0 group-data-[nav-state="mobile-open"]:pointer-events-auto;
    }
</style>

<header>
    <nav id="nav" aria-label="Navigation" data-nav-state="closed" class="group">
        <!-- Background Layers -->
        <div id="nav-dots"></div>
        <div id="nav-background-blur"></div>

        <!-- Desktop & Header Content -->
        <div id="nav-content">
            <Logo />

            <div class="flex items-center gap-x-4 lg:hidden">
                <ThemePicker />
                <MobileNavButton class="w-8 h-8 p-1" />
            </div>

            <div class="hidden lg:flex lg:items-center lg:gap-x-12">
                {SiteConfig.navLinks.map((link) => <NavLink text={link.text} href={link.href} />)}
                <ThemePicker />
            </div>
        </div>

        <!-- Mobile Navigation Menu -->
        <div id="nav-mobile-links">
            {
                SiteConfig.navLinks.map((link) => (
                    <NavLink text={link.text} href={link.href} type="mobile" />
                ))
            }
        </div>
    </nav>
</header>

<script>
    const initNav = () => {
        const nav = document.getElementById("nav");

        const updateNavState = () => {
            if (nav?.getAttribute("data-nav-state") === "mobile-open") return;
            
            const currentScrollY = window.scrollY;
            const isSquished = currentScrollY > 225;
            const currentStatus = nav?.getAttribute("data-nav-squished");

            if (currentStatus !== isSquished.toString()) {
                nav?.setAttribute("data-nav-squished", isSquished.toString());
            }
        };

        // Initial check
        updateNavState();

        window.addEventListener("scroll", updateNavState, { passive: true });
    };

    // Initialize on first load and re-initialize on view transition
    document.addEventListener("astro:page-load", initNav);
</script>
