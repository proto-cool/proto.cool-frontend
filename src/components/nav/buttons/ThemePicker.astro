---
import SiteConfig from "@/site.config";

const themes = SiteConfig.themes;
---

<div class="relative inline-block text-left -ml-4" data-theme-picker>
    <button
        type="button"
        class="flex items-center justify-center gap-1 px-1 h-8 rounded-md hover:bg-theme-bg-secondary transition-colors hover:cursor-pointer"
        id="theme-menu-button"
        aria-expanded="false"
        aria-haspopup="true"
    >
        <div class="theme-preview-icon w-6 h-6 border-2 border-theme-fg-tertiary/20 overflow-hidden flex flex-shrink-0 rounded">
            <div class="w-1/2 h-full bg-theme-bg-secondary"></div>
            <div class="w-1/2 h-full flex flex-col">
                <div class="h-1/2 w-full bg-theme-fg-primary"></div>
                <div class="h-1/2 w-full bg-theme-color-secondary"></div>
            </div>
        </div>
        <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 20 20"
            fill="currentColor"
            class="w-4 h-4 text-theme-fg-tertiary"
        >
            <path
                fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                clip-rule="evenodd"></path>
        </svg>
    </button>

    <div
        class="absolute right-0 z-50 mt-2 w-40 md:w-36 origin-top-right rounded-md bg-theme-bg-primary shadow-lg ring-2 ring-black/10 focus:outline-none transition-all duration-150 opacity-0 scale-95 pointer-events-none"
        id="theme-menu"
        role="menu"
        aria-orientation="vertical"
        aria-labelledby="theme-menu-button"
        tabindex="-1"
    >
        <div class="py-1" role="none">
            {
                themes.map((theme) => (
                    <button
                        class="theme-option flex items-center justify-between w-full px-4 py-2 text-base md:text-sm text-theme-fg-primary hover:bg-theme-bg-secondary transition-colors hover:cursor-pointer"
                        role="menuitem"
                        data-theme-name={theme.name}
                    >
                        <span class="theme-label">{theme.label}</span>
                        <div class="w-4 h-4 border-2 border-theme-fg-tertiary/20 overflow-hidden flex flex-shrink-0 rounded-sm">
                            <div class="w-1/2 h-full" style={`background-color: ${theme.preview.bg}`} />
                            <div class="w-1/2 h-full flex flex-col">
                                <div class="h-1/2 w-full" style={`background-color: ${theme.preview.fg}`} />
                                <div class="h-1/2 w-full" style={`background-color: ${theme.preview.accent}`} />
                            </div>
                        </div>
                    </button>
                ))
            }
        </div>
    </div>
</div>

<style>
    @reference "@/styles/main.css";
</style>

<script>
    function setupThemePicker() {
        const pickers = document.querySelectorAll("[data-theme-picker]");

        pickers.forEach((picker) => {
            if (picker.getAttribute("data-initialized")) return;
            picker.setAttribute("data-initialized", "true");

            const button = picker.querySelector("#theme-menu-button");
            const menu = picker.querySelector("#theme-menu");
            const options = picker.querySelectorAll(".theme-option");

            button?.addEventListener("click", (e) => {
                e.stopPropagation();
                const expanded = button.getAttribute("aria-expanded") === "true";
                const isOpening = !expanded;
                button.setAttribute("aria-expanded", isOpening.toString());
                
                if (isOpening) {
                    menu?.classList.remove("opacity-0", "scale-95", "pointer-events-none");
                    menu?.classList.add("opacity-100", "scale-100");
                    
                    // Highlight active theme
                    const currentTheme = document.documentElement.getAttribute("data-theme");
                    options.forEach((opt) => {
                        const optTheme = opt.getAttribute("data-theme-name");
                        const label = opt.querySelector(".theme-label");
                        if (optTheme === currentTheme) {
                            opt.classList.add("bg-theme-bg-secondary");
                            label?.classList.add("font-bold");
                        } else {
                            opt.classList.remove("bg-theme-bg-secondary");
                            label?.classList.remove("font-bold");
                        }
                    });
                } else {
                    menu?.classList.add("opacity-0", "scale-95", "pointer-events-none");
                    menu?.classList.remove("opacity-100", "scale-100");
                }

                // Close other pickers if any
                pickers.forEach((otherPicker) => {
                    if (otherPicker !== picker) {
                        otherPicker.querySelector("#theme-menu-button")?.setAttribute("aria-expanded", "false");
                        const otherMenu = otherPicker.querySelector("#theme-menu");
                        otherMenu?.classList.add("opacity-0", "scale-95", "pointer-events-none");
                        otherMenu?.classList.remove("opacity-100", "scale-100");
                    }
                });
            });

            options.forEach((option) => {
                option.addEventListener("click", () => {
                    const theme = option.getAttribute("data-theme-name");
                    if (theme) {
                        document.documentElement.setAttribute("data-theme", theme);
                        localStorage.setItem("theme", theme);
                        button?.setAttribute("aria-expanded", "false");
                        menu?.classList.add("opacity-0", "scale-95", "pointer-events-none");
                        menu?.classList.remove("opacity-100", "scale-100");
                    }
                });
            });

            document.addEventListener("click", (e) => {
                if (!picker.contains(e.target as Node)) {
                    button?.setAttribute("aria-expanded", "false");
                    menu?.classList.add("opacity-0", "scale-95", "pointer-events-none");
                    menu?.classList.remove("opacity-100", "scale-100");
                }
            });
        });
    }

    // Run on view transitions
    document.addEventListener("astro:page-load", setupThemePicker);
</script>
